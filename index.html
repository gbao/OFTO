<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFTO Scheme: Has Unbundling Delivered Value</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- D3.js for sophisticated visualizations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- SheetJS for Excel file reading -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- McKinsey-style professional fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        /* McKinsey-style professional typography */
        body {
            font-family: 'Lato', sans-serif;
            font-weight: 400;
            letter-spacing: -0.01em;
            color: #1a1a1a;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Lato', sans-serif;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .serif-text {
            font-family: 'Merriweather', serif;
        }

        /* McKinsey color palette */
        :root {
            --mckinsey-blue: #003d7a;
            --mckinsey-light-blue: #0073cf;
            --mckinsey-teal: #00a9ce;
            --mckinsey-gray: #5f6062;
            --mckinsey-light-gray: #e6e7e8;
            --chart-green: #00ab84;
            --chart-orange: #ff8200;
            --chart-purple: #6e2c91;
        }

        .tab-active {
            border-bottom: 3px solid var(--mckinsey-blue);
            color: var(--mckinsey-blue);
            font-weight: 700;
        }

        .tab-content {
            display: none;
        }

        .tab-content-active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* Chart containers with McKinsey styling */
        .chart-container {
            background: white;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            padding: 32px 24px;
            min-height: 400px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--mckinsey-blue);
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .chart-subtitle {
            font-size: 13px;
            color: var(--mckinsey-gray);
            margin-bottom: 24px;
            font-weight: 300;
        }

        /* D3 chart styling */
        .axis text {
            font-family: 'Lato', sans-serif;
            font-size: 11px;
            fill: var(--mckinsey-gray);
        }

        .axis line,
        .axis path {
            stroke: var(--mckinsey-light-gray);
            stroke-width: 1px;
        }

        .grid line {
            stroke: var(--mckinsey-light-gray);
            stroke-opacity: 0.5;
            stroke-width: 1px;
        }

        /* Report styling - McKinsey pyramid principle */
        .insight-box {
            background: #f8f9fa;
            border-left: 4px solid var(--mckinsey-blue);
            padding: 20px 24px;
            margin: 24px 0;
            font-weight: 400;
        }

        .key-message {
            font-size: 18px;
            font-weight: 700;
            color: var(--mckinsey-blue);
            line-height: 1.5;
        }

        .supporting-point {
            margin-left: 24px;
            position: relative;
            padding-left: 16px;
        }

        .supporting-point::before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--mckinsey-blue);
            font-weight: 700;
        }

        /* File upload section */
        .upload-section {
            background: linear-gradient(135deg, var(--mckinsey-blue) 0%, var(--mckinsey-light-blue) 100%);
            border-radius: 4px;
            padding: 32px;
            text-align: center;
            margin-bottom: 32px;
            color: white;
        }

        .upload-btn {
            background: white;
            color: var(--mckinsey-blue);
            padding: 12px 32px;
            border-radius: 4px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 14px;
            letter-spacing: 0.02em;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .data-status {
            font-size: 13px;
            margin-top: 16px;
            opacity: 0.9;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <div class="bg-white border-b-2" style="border-color: var(--mckinsey-blue);">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold" style="color: var(--mckinsey-blue);">OFTO Scheme Analysis</h1>
                    <p class="text-sm mt-1" style="color: var(--mckinsey-gray); font-weight: 300;">Has Unbundling Delivered Value</p>
                </div>
                <div class="text-right">
                    <p class="text-xs uppercase tracking-wide" style="color: var(--mckinsey-gray); font-weight: 700;">Opinion Piece</p>
                    <p class="text-sm font-light mt-1" style="color: var(--mckinsey-gray);">October 2025</p>
                </div>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- Tab Navigation -->
        <div class="border-b border-gray-300">
            <nav class="flex -mb-px space-x-6 sm:space-x-8" aria-label="Tabs">
                <button onclick="changeTab('visualizations')" id="tab-visualizations" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300 tab-active">
                    Visualizations
                </button>
                <button onclick="changeTab('report')" id="tab-report" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">
                    Analysis
                </button>
                <button onclick="changeTab('references')" id="tab-references" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">
                    References & Sources
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="mt-8">
            <!-- Visualizations Content -->
            <div id="content-visualizations" class="tab-content tab-content-active fade-in">
                <!-- Charts Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Chart 1: Technical Availability by Project -->
                    <div class="chart-container">
                        <div class="chart-title">OFTO Availability Performance</div>
                        <div class="chart-subtitle">Average annual availability since project inception (%)</div>
                        <div id="chart1"></div>
                        <p class="text-xs mt-4 mb-3" style="color: var(--mckinsey-gray);">Source: <a href="https://www.neso.energy/industry-information/industry-data-and-reports/system-performance-reports" target="_blank" style="color: var(--mckinsey-blue); text-decoration: underline;">NESO - Offshore System Availability</a> (Adjusted with Exception Events approved by OFGEM)</p>
                        <div class="p-3 mt-2 rounded" style="background-color: #f0f4f8; border-left: 3px solid var(--mckinsey-blue);">
                            <p class="text-sm" style="color: var(--mckinsey-gray); font-weight: 500;">Industry performance exceeds Ofgem's ~98% target, with >99% average availability. Figures reflect OFGEM-approved Exception Event adjustments; unadjusted availability is materially lower.</p>
                        </div>
                    </div>

                    <!-- Chart 2: Ownership Capacity -->
                    <div class="chart-container">
                        <div class="chart-title">OFTO capacity by owner</div>
                        <div class="chart-subtitle">Total transmission capacity (MW)</div>
                        <div id="chart2"></div>
                        <p class="text-xs mt-4 mb-3" style="color: var(--mckinsey-gray);">Source: Ofgem, industry filings; capacity adjusted to ownership stake</p>
                        <div class="p-3 mt-2 rounded" style="background-color: #f0f4f8; border-left: 3px solid var(--mckinsey-blue);">
                            <p class="text-sm" style="color: var(--mckinsey-gray); font-weight: 500;">Diamond Transmission Partners and Transmission Capital Partners dominate with ~69% of total capacity combined.</p>
                        </div>
                    </div>

                    <!-- Chart 3: Revenue per MW by Tender Round -->
                    <div class="chart-container">
                        <div class="chart-title">Annual Revenue per MW by Tender Round</div>
                        <div class="chart-subtitle">TRS per megawatt capacity (£/MW)</div>
                        <div id="chart3"></div>
                        <p class="text-xs mt-4" style="color: var(--mckinsey-gray);">Source: Ofgem tender documentation, project filings</p>
                    </div>

                    <!-- Chart 4: Capacity vs Transfer Value -->
                    <div class="chart-container">
                        <div class="chart-title">Project Scale vs Transfer Value</div>
                        <div class="chart-subtitle">Capacity (MW) vs Transfer Value (£m), sized by Annual TRS</div>
                        <div id="chart4"></div>
                        <p class="text-xs mt-4" style="color: var(--mckinsey-gray);">Source: Ofgem OFTO transfer documentation</p>
                    </div>

                    <!-- Chart 5: Placeholder -->
                    <div class="chart-container">
                        <div class="chart-title">Chart 5 - Coming Soon</div>
                        <div class="chart-subtitle">Placeholder for future analysis</div>
                        <div id="chart5" style="min-height: 300px; display: flex; align-items: center; justify-content: center; background-color: #f8fafc; border: 2px dashed var(--mckinsey-light-gray); border-radius: 8px;">
                            <div style="text-align: center; color: var(--mckinsey-gray);">
                                <svg style="width: 64px; height: 64px; margin: 0 auto 16px; opacity: 0.3;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <p style="font-weight: 600; margin-bottom: 8px;">Visualization Placeholder</p>
                                <p style="font-size: 14px;">Additional analysis coming soon</p>
                            </div>
                        </div>
                        <p class="text-xs mt-4" style="color: var(--mckinsey-gray);">Source: TBD</p>
                    </div>

                    <!-- Chart 6: Placeholder -->
                    <div class="chart-container">
                        <div class="chart-title">Chart 6 - Coming Soon</div>
                        <div class="chart-subtitle">Placeholder for future analysis</div>
                        <div id="chart6" style="min-height: 300px; display: flex; align-items: center; justify-content: center; background-color: #f8fafc; border: 2px dashed var(--mckinsey-light-gray); border-radius: 8px;">
                            <div style="text-align: center; color: var(--mckinsey-gray);">
                                <svg style="width: 64px; height: 64px; margin: 0 auto 16px; opacity: 0.3;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                </svg>
                                <p style="font-weight: 600; margin-bottom: 8px;">Visualization Placeholder</p>
                                <p style="font-size: 14px;">Additional analysis coming soon</p>
                            </div>
                        </div>
                        <p class="text-xs mt-4" style="color: var(--mckinsey-gray);">Source: TBD</p>
                    </div>
                </div>
            </div>

            <!-- Report Content -->
            <div id="content-report" class="tab-content">
                <!-- Report Header Box - Full Width -->
                <div class="upload-section mb-8">
                    <h2 class="text-2xl font-bold mb-3">OFTO Scheme Infographic Deep Dive</h2>

                    <!-- Three Interactive Boxes -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <!-- First Box: Overview -->
                        <div onclick="openOverview()" class="bg-white p-4 rounded cursor-pointer hover:shadow-lg transition-all duration-200 transform hover:-translate-y-0.5" style="border: 2px solid var(--mckinsey-blue);">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 mr-2" style="color: var(--mckinsey-blue);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                    </svg>
                                    <h3 class="text-base font-bold" style="color: var(--mckinsey-blue);">Overview</h3>
                                </div>
                                <svg class="w-5 h-5" style="color: var(--mckinsey-blue);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                            <p class="text-xs mt-2" style="color: var(--mckinsey-gray);">OFTO scheme summary</p>
                        </div>

                        <!-- Second Box: Key Regulatory Milestones -->
                        <div onclick="openRegulatoryMilestones()" class="bg-white p-4 rounded cursor-pointer hover:shadow-lg transition-all duration-200 transform hover:-translate-y-0.5" style="border: 2px solid var(--mckinsey-blue);">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 mr-2" style="color: var(--mckinsey-blue);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <h3 class="text-base font-bold" style="color: var(--mckinsey-blue);">Key Regulatory Milestones</h3>
                                </div>
                                <svg class="w-5 h-5" style="color: var(--mckinsey-blue);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                            <p class="text-xs mt-2" style="color: var(--mckinsey-gray);">2004-2025 timeline</p>
                        </div>

                        <!-- Third Box: OFTO Tender Process -->
                        <div onclick="openTenderProcess()" class="bg-white p-4 rounded cursor-pointer hover:shadow-lg transition-all duration-200 transform hover:-translate-y-0.5" style="border: 2px solid var(--mckinsey-blue);">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 mr-2" style="color: var(--mckinsey-blue);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h3 class="text-base font-bold" style="color: var(--mckinsey-blue);">OFTO Tender Process</h3>
                                </div>
                                <svg class="w-5 h-5" style="color: var(--mckinsey-blue);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                            <p class="text-xs mt-2" style="color: var(--mckinsey-gray);">6-stage competitive process</p>
                        </div>
                    </div>
                </div>

                <!-- Modal Overlay for Tender Process -->
                <div id="tenderProcessModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 overflow-y-auto" style="-webkit-overflow-scrolling: touch;">
                    <div class="min-h-screen p-4 pt-8">
                        <div class="bg-white rounded-lg shadow-2xl w-full max-w-6xl mx-auto mb-8">
                            <!-- Modal Header - Sticky -->
                            <div class="sticky top-0 z-10 flex justify-between items-center p-6 border-b" style="background: linear-gradient(135deg, var(--mckinsey-blue) 0%, var(--mckinsey-light-blue) 100%);">
                                <h2 class="text-2xl font-bold text-white">The Competitive Tender Process</h2>
                                <button onclick="closeTenderProcess()" class="text-white hover:text-gray-200 text-3xl font-bold leading-none">&times;</button>
                            </div>

                            <!-- Modal Content -->
                            <div id="tenderProcessContent" class="p-8" style="background-color: #f7f9fc;">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Overlay for Overview -->
                <div id="overviewModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 overflow-y-auto" style="-webkit-overflow-scrolling: touch;">
                    <div class="min-h-screen p-4 pt-8">
                        <div class="bg-white rounded-lg shadow-2xl w-full max-w-6xl mx-auto mb-8">
                            <!-- Modal Header - Sticky -->
                            <div class="sticky top-0 z-10 flex justify-between items-center p-6 border-b" style="background: linear-gradient(135deg, var(--mckinsey-blue) 0%, var(--mckinsey-light-blue) 100%);">
                                <h2 class="text-2xl font-bold text-white">OFTO Scheme Overview</h2>
                                <button onclick="closeOverview()" class="text-white hover:text-gray-200 text-3xl font-bold leading-none">&times;</button>
                            </div>

                            <!-- Modal Content -->
                            <div id="overviewContent" class="p-8" style="background-color: #f7f9fc;">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Overlay for Regulatory Milestones -->
                <div id="regulatoryMilestonesModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 overflow-y-auto" style="-webkit-overflow-scrolling: touch;">
                    <div class="min-h-screen p-4 pt-8">
                        <div class="bg-white rounded-lg shadow-2xl w-full max-w-6xl mx-auto mb-8">
                            <!-- Modal Header - Sticky -->
                            <div class="sticky top-0 z-10 flex justify-between items-center p-6 border-b" style="background: linear-gradient(135deg, var(--mckinsey-blue) 0%, var(--mckinsey-light-blue) 100%);">
                                <h2 class="text-2xl font-bold text-white">Key Regulatory Milestones</h2>
                                <button onclick="closeRegulatoryMilestones()" class="text-white hover:text-gray-200 text-3xl font-bold leading-none">&times;</button>
                            </div>

                            <!-- Modal Content -->
                            <div id="regulatoryMilestonesContent" class="p-8" style="background-color: #f7f9fc;">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Op-Ed Content Placeholder -->
                <div class="bg-white p-8 sm:p-12 rounded-sm shadow-sm" style="max-width: 900px; margin: 0 auto;">
                    <!-- Article Header -->
                    <div class="mb-8 pb-6 border-b-2" style="border-color: var(--mckinsey-blue);">
                        <h1 class="text-3xl sm:text-4xl font-bold mb-4" style="color: var(--mckinsey-blue);">
                            [Article Title Goes Here]
                        </h1>
                        <p class="text-lg mb-4" style="color: var(--mckinsey-gray); font-style: italic;">
                            [Subtitle or key thesis statement]
                        </p>
                        <div class="flex items-center text-sm" style="color: var(--mckinsey-gray);">
                            <span class="font-semibold">By [Author Name]</span>
                            <span class="mx-2">•</span>
                            <span>[Date]</span>
                            <span class="mx-2">•</span>
                            <span>[Reading Time] min read</span>
                        </div>
                    </div>

                    <!-- Article Body -->
                    <article class="prose prose-lg max-w-none">
                        <p class="text-lg leading-relaxed mb-6">
                            [Opening paragraph - start with your hook or key argument here...]
                        </p>

                        <h2 class="text-2xl font-bold mt-8 mb-4" style="color: var(--mckinsey-blue);">
                            [Section Heading 1]
                        </h2>
                        <p class="leading-relaxed mb-4">
                            [Your analysis content goes here...]
                        </p>

                        <h2 class="text-2xl font-bold mt-8 mb-4" style="color: var(--mckinsey-blue);">
                            [Section Heading 2]
                        </h2>
                        <p class="leading-relaxed mb-4">
                            [More content here...]
                        </p>

                        <!-- Pull Quote Example -->
                        <div class="p-6 my-8 border-l-4 bg-gray-50 rounded" style="border-color: var(--mckinsey-blue);">
                            <p class="text-xl font-semibold italic mb-2" style="color: var(--mckinsey-blue);">
                                "[Insert notable quote or key insight here]"
                            </p>
                        </div>

                        <h2 class="text-2xl font-bold mt-8 mb-4" style="color: var(--mckinsey-blue);">
                            Conclusion
                        </h2>
                        <p class="leading-relaxed mb-4">
                            [Concluding thoughts and policy recommendations...]
                        </p>
                    </article>

                    <!-- Author Bio (Optional) -->
                    <div class="mt-12 pt-6 border-t" style="border-color: var(--mckinsey-light-gray);">
                        <p class="text-sm" style="color: var(--mckinsey-gray);">
                            <strong>[Author Name]</strong> is [brief bio/credentials]. The views expressed are the author's own.
                        </p>
                    </div>
                </div>
            </div>

            <!-- References Content -->
            <div id="content-references" class="tab-content">
                 <div class="bg-white p-8 rounded-lg shadow">
                    <h2 class="text-2xl font-bold mb-6 border-b pb-2">References & Sources</h2>
                    <ul class="list-disc list-inside space-y-4 text-gray-700">
                        <li>
                            <strong>[Source Name 1]</strong> - "[Title of Publication or Report]," Publisher, Year. Link: <a href="#" class="text-blue-600 hover:underline">[URL]</a>
                        </li>
                        <li>
                            <strong>[Source Name 2]</strong> - "[Title of Article]," Journal of Financial Regulation, Vol. X, Issue Y, pp. 123-456, Date.
                        </li>
                         <li>
                            <strong>[Regulatory Body]</strong> - "Annual Industry Report [Year]," official website. Link: <a href="#" class="text-blue-600 hover:underline">[URL]</a>
                        </li>
                        <li>
                            <strong>[Company Name]</strong> - "Annual Financial Statements [Year]," Investor Relations Portal. Link: <a href="#" class="text-blue-600 hover:underline">[URL]</a>
                        </li>
                        <li>
                            <strong>Internal Analysis</strong> - Financial Models and Projections developed by [Your Firm's Name] Equity Research.
                        </li>
                    </ul>
                 </div>
            </div>
        </div>
    </main>

    <footer class="bg-white mt-12 border-t">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
            <p>&copy; 2025 [Your Company Name]. All Rights Reserved.</p>
            <p class="mt-1">This report is for informational purposes only and does not constitute an offer to sell or a solicitation of an offer to buy any securities.</p>
        </div>
    </footer>

    <script>
        // ===== GLOBAL STATE MANAGEMENT =====
        let activeTab = 'visualizations';
        let excelData = null;  // Stores parsed Excel data (stays local, never transmitted)
        let visualizationData = null;  // Filtered data for charts

        // McKinsey color palette
        const colors = {
            blue: '#003d7a',
            lightBlue: '#0073cf',
            teal: '#00a9ce',
            green: '#00ab84',
            orange: '#ff8200',
            purple: '#6e2c91',
            gray: '#5f6062',
            lightGray: '#e6e7e8'
        };

        // ===== TAB NAVIGATION =====
        function changeTab(tabName) {
            const oldTabButton = document.getElementById(`tab-${activeTab}`);
            const newTabButton = document.getElementById(`tab-${tabName}`);
            const oldTabContent = document.getElementById(`content-${activeTab}`);
            const newTabContent = document.getElementById(`content-${tabName}`);

            oldTabButton.classList.remove('tab-active');
            newTabButton.classList.add('tab-active');

            if (oldTabContent) oldTabContent.classList.remove('tab-content-active');
            if (newTabContent) {
                newTabContent.classList.add('tab-content-active');
                newTabContent.classList.remove('fade-in');
                void newTabContent.offsetWidth;
                newTabContent.classList.add('fade-in');
            }

            activeTab = tabName;
        }

        // ===== SECURE DATA HANDLING =====
        // All data processing happens in browser - nothing sent to server
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});

                    // Store raw Excel data locally
                    excelData = {};
                    workbook.SheetNames.forEach(sheetName => {
                        excelData[sheetName] = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    });

                    // Process data for visualizations
                    processDataForVisualizations();

                    // Update status
                    document.getElementById('dataStatus').innerHTML =
                        `<span style="color: #00ab84;">✓ Data loaded successfully</span> (${workbook.SheetNames.length} sheets, ${Object.values(excelData).reduce((acc, sheet) => acc + sheet.length, 0)} rows)`;

                    // Render charts
                    renderAllCharts();
                } catch (error) {
                    document.getElementById('dataStatus').innerHTML =
                        `<span style="color: #ff8200;">⚠ Error loading file: ${error.message}</span>`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ===== DATA PROCESSING LAYER =====
        // Filter and transform data - only expose what's needed for visualization
        function processDataForVisualizations() {
            // This function processes your Excel data
            // Customize based on your actual Excel structure
            visualizationData = {
                ownershipData: extractOwnershipData(),
                marketShareData: extractMarketShareData(),
                oftoProjectData: extractOFTOProjectData()
            };
        }

        // Example data extraction functions - customize these based on your Excel structure
        function extractOwnershipData() {
            // Look for sheet with ownership data
            if (excelData && excelData['Ownership']) {
                return excelData['Ownership'];
            }
            // Return OFTO ownership distribution data
            return [
                {owner: 'Diamond Transmission Partners', capacity: 4375, capacityAdjusted: 4375},
                {owner: 'Transmission Capital Partners', capacity: 4072, capacityAdjusted: 4072},
                {owner: 'Equitix', capacity: 504, capacityAdjusted: 1659.2},
                {owner: 'Blue Transmission', capacity: 1313, capacityAdjusted: 1313},
                {owner: 'Balfour Beatty Capital', capacity: 219, capacityAdjusted: 623.4},
                {owner: 'WoDS Transmission Plc', capacity: 388, capacityAdjusted: 388},
                {owner: 'TEPCO', capacity: 0, capacityAdjusted: 171.4}
            ];
        }

        function extractMarketShareData() {
            if (excelData && excelData['Availability']) {
                return excelData['Availability'];
            }
            // Average OFTO Technical Availability by Year (across all projects)
            return [
                {year: '2011-12', availability: 99.97},
                {year: '2012-13', availability: 99.56},
                {year: '2013-14', availability: 99.26},
                {year: '2014-15', availability: 96.87},
                {year: '2015-16', availability: 96.92},
                {year: '2016-17', availability: 99.80},
                {year: '2017-18', availability: 99.82},
                {year: '2018-19', availability: 99.32},
                {year: '2019-20', availability: 99.89},
                {year: '2020-21', availability: 99.84},
                {year: '2021-22', availability: 99.81},
                {year: '2022-23', availability: 99.46},
                {year: '2023-24', availability: 98.64},
                {year: '2024-25', availability: 98.94}
            ];
        }

        function extractOFTOProjectData() {
            if (excelData && excelData['OFTOProjects']) {
                return excelData['OFTOProjects'];
            }
            // OFTO Project Data
            return [
                { tr: "TR1", project: "Robin Rigg", capacity: 180, value: 65.5, trs: 6.533, trs_per_mw: 36294, year: 2011 },
                { tr: "TR1", project: "Gunfleet Sands", capacity: 173, value: 49.5, trs: 6.106, trs_per_mw: 35295, year: 2011 },
                { tr: "TR1", project: "Barrow", capacity: 90, value: 33.6, trs: 4.991, trs_per_mw: 55456, year: 2011 },
                { tr: "TR1", project: "Walney 1", capacity: 184, value: 105.4, trs: 11.558, trs_per_mw: 62816, year: 2011 },
                { tr: "TR1", project: "Ormonde", capacity: 150, value: 103.9, trs: 10.603, trs_per_mw: 70687, year: 2012 },
                { tr: "TR1", project: "Walney 2", capacity: 184, value: 109.8, trs: 12.466, trs_per_mw: 67748, year: 2012 },
                { tr: "TR1", project: "Sheringham Shoal", capacity: 315, value: 193.1, trs: 10.9, trs_per_mw: 34603, year: 2016 },
                { tr: "TR1", project: "Greater Gabbard", capacity: 504, value: 317.1, trs: 26.793, trs_per_mw: 53161, year: 2013 },
                { tr: "TR1", project: "Thanet", capacity: 300, value: 163.5, trs: 16.874, trs_per_mw: 56247, year: 2014 },
                { tr: "TR2", project: "London Array", capacity: 630, value: 472.5, trs: 34.936, trs_per_mw: 55453, year: 2013 },
                { tr: "TR2", project: "Lincs", capacity: 270, value: 322, trs: 24.635, trs_per_mw: 91241, year: 2014 },
                { tr: "TR2", project: "Gwynt y Môr", capacity: 574, value: 351.9, trs: 25.152, trs_per_mw: 43819, year: 2015 },
                { tr: "TR2", project: "West of Duddon Sands", capacity: 388, value: 268.9, trs: 19.691, trs_per_mw: 50750, year: 2015 },
                { tr: "TR3", project: "Westermost Rough", capacity: 205, value: 156.7, trs: 11.315, trs_per_mw: 55195, year: 2016 },
                { tr: "TR3", project: "Humber Gateway", capacity: 219, value: 162.9, trs: 10.9, trs_per_mw: 49772, year: 2016 },
                { tr: "TR4", project: "Burbo Bank Extension", capacity: 258, value: 193.9, trs: 11.374, trs_per_mw: 44085, year: 2018 },
                { tr: "TR5", project: "Dudgeon", capacity: 402, value: 297.9, trs: 17.924, trs_per_mw: 44588, year: 2018 },
                { tr: "TR5", project: "Race Bank", capacity: 573, value: 472.5, trs: 25.568, trs_per_mw: 44621, year: 2019 },
                { tr: "TR5", project: "Galloper", capacity: 340, value: 281.8, trs: 16.032, trs_per_mw: 47153, year: 2020 },
                { tr: "TR5", project: "Walney Extension", capacity: 600, value: 446.6, trs: 25.181, trs_per_mw: 41968, year: 2020 },
                { tr: "TR5", project: "Rampion", capacity: 400, value: 279.5, trs: 14.969, trs_per_mw: 37423, year: 2021 },
                { tr: "TR6", project: "Hornsea One", capacity: 1218, value: 1175, trs: 43.412, trs_per_mw: 35642, year: 2021 },
                { tr: "TR6", project: "Beatrice", capacity: 588, value: 437.9, trs: 18.34, trs_per_mw: 31190, year: 2021 },
                { tr: "TR6", project: "East Anglia One", capacity: 714, value: 692.6, trs: 32.719, trs_per_mw: 45825, year: 2022 },
                { tr: "TR7", project: "Moray East", capacity: 900, value: 666.1, trs: 26.614, trs_per_mw: 29571, year: 2024 },
                { tr: "TR7", project: "Triton Knoll", capacity: 857, value: 572.7, trs: 33.809, trs_per_mw: 39451, year: 2024 },
                { tr: "TR8", project: "Hornsea Two", capacity: 1386, value: 1141.2, trs: 50.491, trs_per_mw: 36429, year: 2023 }
            ];
        }

        // ===== D3.JS VISUALIZATION FUNCTIONS =====

        function renderAllCharts() {
            renderChart1();  // Line chart
            renderChart2();  // Bar chart
            renderChart3();  // Waterfall chart
            renderChart4();  // Distribution chart
        }

        // Chart 1: OFTO Technical Availability Trend (Line Chart)
        function renderChart1() {
            const container = document.getElementById('chart1');
            container.innerHTML = '';

            const margin = {top: 20, right: 30, bottom: 60, left: 60};
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 340 - margin.top - margin.bottom;

            const svg = d3.select('#chart1')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const data = visualizationData?.marketShareData || extractMarketShareData();

            // Scales
            const x = d3.scaleBand()
                .domain(data.map(d => d.year))
                .range([0, width])
                .padding(0.1);

            const y = d3.scaleLinear()
                .domain([95, 101])
                .range([height, 0]);

            // Line generator
            const line = d3.line()
                .x(d => x(d.year) + x.bandwidth() / 2)
                .y(d => y(d.availability))
                .curve(d3.curveMonotoneX);

            // Grid lines
            svg.append('g')
                .attr('class', 'grid')
                .attr('opacity', 0.1)
                .call(d3.axisLeft(y)
                    .tickSize(-width)
                    .tickFormat('')
                );

            // Add threshold line at 98% - bright red for visibility
            svg.append('line')
                .attr('x1', 0)
                .attr('x2', width)
                .attr('y1', y(98))
                .attr('y2', y(98))
                .attr('stroke', '#ef4444')
                .attr('stroke-width', 3)
                .attr('stroke-dasharray', '8,4')
                .attr('opacity', 1);

            // Threshold label with background for visibility
            const thresholdLabel = svg.append('g');

            thresholdLabel.append('rect')
                .attr('x', width - 105)
                .attr('y', y(98) - 18)
                .attr('width', 100)
                .attr('height', 16)
                .attr('fill', 'white')
                .attr('opacity', 0.95)
                .attr('rx', 3);

            thresholdLabel.append('text')
                .attr('x', width - 55)
                .attr('y', y(98) - 6)
                .attr('text-anchor', 'middle')
                .attr('font-size', '11px')
                .attr('fill', '#ef4444')
                .attr('font-weight', '700')
                .text('98% threshold');

            // Highlight area below 98% threshold
            data.forEach((d, i) => {
                if (d.availability < 98) {
                    svg.append('rect')
                        .attr('x', x(d.year))
                        .attr('y', y(d.availability))
                        .attr('width', x.bandwidth())
                        .attr('height', y(98) - y(d.availability))
                        .attr('fill', '#fca5a5')
                        .attr('opacity', 0.3);
                }
            });

            // Draw line
            svg.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', colors.blue)
                .attr('stroke-width', 3)
                .attr('d', line);

            // Add data points
            svg.selectAll('.dot')
                .data(data)
                .enter()
                .append('circle')
                .attr('class', 'dot')
                .attr('cx', d => x(d.year) + x.bandwidth() / 2)
                .attr('cy', d => y(d.availability))
                .attr('r', d => d.availability < 98 ? 6 : 4)
                .attr('fill', d => d.availability < 98 ? '#dc2626' : colors.blue)
                .attr('stroke', 'white')
                .attr('stroke-width', 2);

            // Value labels - show selectively to reduce density
            svg.selectAll('.value-label')
                .data(data)
                .enter()
                .filter((d, i) => {
                    // Show labels for: first, last, below threshold, and every 3rd year
                    return i === 0 || i === data.length - 1 || d.availability < 98 || i % 3 === 0;
                })
                .append('text')
                .attr('x', d => x(d.year) + x.bandwidth() / 2)
                .attr('y', d => {
                    // Position 2014-15 and 2015-16 below the point
                    if (d.year === '2014-15' || d.year === '2015-16') {
                        return y(d.availability) + 18;
                    }
                    // If close to 98% threshold, position label strategically
                    if (Math.abs(d.availability - 98) < 0.5) {
                        return d.availability > 98 ? y(d.availability) - 10 : y(d.availability) + 18;
                    }
                    return y(d.availability) - 10;
                })
                .attr('text-anchor', 'middle')
                .attr('font-size', '10px')
                .attr('font-weight', '700')
                .attr('fill', d => d.availability < 98 ? '#ef4444' : colors.gray)
                .text(d => `${d.availability.toFixed(2)}%`);

            // X-axis
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .style('font-size', '10px')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');

            // Y-axis with 1% steps
            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y).ticks(6).tickValues([95, 96, 97, 98, 99, 100, 101]).tickFormat(d => `${d}%`));

            // Remove axis lines for cleaner look
            svg.selectAll('.axis path').remove();
            svg.selectAll('.axis line').attr('stroke', colors.lightGray);
        }

        // Chart 2: OFTO Capacity by Owner (McKinsey-style Bar Chart)
        function renderChart2() {
            const container = document.getElementById('chart2');
            container.innerHTML = '';

            const margin = {top: 20, right: 80, bottom: 40, left: 180};
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 360 - margin.top - margin.bottom;

            const svg = d3.select('#chart2')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const data = visualizationData?.ownershipData || extractOwnershipData();

            // Sort by adjusted capacity descending
            const sortedData = data.sort((a, b) => b.capacityAdjusted - a.capacityAdjusted);

            // Scales
            const x = d3.scaleLinear()
                .domain([0, d3.max(sortedData, d => d.capacityAdjusted) * 1.15])
                .range([0, width]);

            const y = d3.scaleBand()
                .domain(sortedData.map(d => d.owner))
                .range([0, height])
                .padding(0.25);

            // Color scale - gradient from dark to light blue
            const colorScale = d3.scaleOrdinal()
                .domain(sortedData.map((d, i) => i))
                .range([colors.blue, colors.lightBlue, colors.teal, colors.green, '#87CEEB', colors.orange, colors.lightGray]);

            // Bars with gradient effect
            svg.selectAll('.bar')
                .data(sortedData)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', 0)
                .attr('y', d => y(d.owner))
                .attr('width', d => x(d.capacityAdjusted))
                .attr('height', y.bandwidth())
                .attr('fill', (d, i) => colorScale(i))
                .attr('rx', 3);

            // Value labels outside bars
            svg.selectAll('.label')
                .data(sortedData)
                .enter()
                .append('text')
                .attr('x', d => x(d.capacityAdjusted) + 5)
                .attr('y', d => y(d.owner) + y.bandwidth() / 2)
                .attr('dy', '.35em')
                .attr('font-size', '11px')
                .attr('font-weight', '700')
                .attr('fill', colors.gray)
                .text(d => {
                    if (d.capacityAdjusted >= 1000) {
                        return `${(d.capacityAdjusted / 1000).toFixed(1)} GW`;
                    }
                    return `${d.capacityAdjusted.toFixed(0)} MW`;
                });

            // Y-axis (owner names)
            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .style('font-size', '11px')
                .style('font-weight', '400');

            // X-axis
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(5).tickFormat(d => {
                    if (d >= 1000) return `${(d / 1000).toFixed(1)} GW`;
                    return `${d} MW`;
                }));

            // Remove axis lines for cleaner McKinsey look
            svg.selectAll('.axis path').remove();
            svg.selectAll('.axis line').attr('stroke', colors.lightGray);
        }

        // Chart 3: Revenue per MW by Tender Round (Scatter Plot)
        function renderChart3() {
            const container = document.getElementById('chart3');
            container.innerHTML = '';

            const margin = {top: 20, right: 30, bottom: 60, left: 80};
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 380 - margin.top - margin.bottom;

            const svg = d3.select('#chart3')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const data = extractOFTOProjectData();

            // Get unique tender rounds and sort them
            const tenderRounds = [...new Set(data.map(d => d.tr))].sort();

            // Color scale for tender rounds
            const colorScale = d3.scaleOrdinal()
                .domain(tenderRounds)
                .range([colors.orange, '#ef4444', colors.blue, colors.lightBlue, colors.teal, colors.green, colors.purple, '#8b5cf6']);

            // X Scale (Tender Rounds)
            const x = d3.scaleBand()
                .domain(tenderRounds)
                .range([0, width])
                .padding(0.1);

            // Y Scale (Revenue per MW)
            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.trs_per_mw) * 1.1])
                .range([height, 0]);

            // Grid lines
            svg.append('g')
                .attr('class', 'grid')
                .attr('opacity', 0.1)
                .call(d3.axisLeft(y).tickSize(-width).tickFormat(''));

            // Create tooltip
            const tooltip = d3.select('body').append('div')
                .style('position', 'absolute')
                .style('visibility', 'hidden')
                .style('background-color', 'white')
                .style('border', '1px solid #ddd')
                .style('border-radius', '6px')
                .style('padding', '12px')
                .style('box-shadow', '0 4px 6px rgba(0,0,0,0.1)')
                .style('font-size', '13px')
                .style('pointer-events', 'none')
                .style('z-index', '1000');

            // Jitter plot with scatter points
            const jitterWidth = x.bandwidth() * 0.6;
            svg.selectAll('.dot')
                .data(data)
                .enter()
                .append('circle')
                .attr('cx', d => x(d.tr) + x.bandwidth() / 2 + (Math.random() - 0.5) * jitterWidth)
                .attr('cy', d => y(d.trs_per_mw))
                .attr('r', 6)
                .attr('fill', d => colorScale(d.tr))
                .attr('opacity', 0.7)
                .attr('stroke', 'white')
                .attr('stroke-width', 1.5)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('r', 9)
                        .attr('opacity', 1);

                    tooltip.html(`
                        <strong style="color: ${colors.blue}; font-size: 14px;">${d.project}</strong><br/>
                        <strong>Tender Round:</strong> ${d.tr}<br/>
                        <strong>Year:</strong> ${d.year}<br/>
                        <strong>Capacity:</strong> ${d.capacity.toLocaleString()} MW<br/>
                        <strong>TRS per MW:</strong> £${d.trs_per_mw.toLocaleString()}<br/>
                        <strong>Annual TRS:</strong> £${d.trs.toFixed(2)}m
                    `)
                    .style('visibility', 'visible');
                })
                .on('mousemove', function(event) {
                    tooltip
                        .style('top', (event.pageY - 10) + 'px')
                        .style('left', (event.pageX + 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('r', 6)
                        .attr('opacity', 0.7);

                    tooltip.style('visibility', 'hidden');
                });

            // X-axis
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .style('font-size', '11px');

            // Y-axis
            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y).ticks(6).tickFormat(d => `£${(d/1000).toFixed(0)}k`));

            // Y-axis label
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', -60)
                .attr('text-anchor', 'middle')
                .attr('font-size', '12px')
                .attr('font-weight', '600')
                .attr('fill', colors.gray)
                .text('Annual TRS per MW');

            // Remove axis lines for cleaner look
            svg.selectAll('.axis path').remove();
            svg.selectAll('.axis line').attr('stroke', colors.lightGray);
        }

        // Chart 4: Capacity vs Transfer Value (Bubble Chart)
        function renderChart4() {
            const container = document.getElementById('chart4');
            container.innerHTML = '';

            const margin = {top: 20, right: 30, bottom: 60, left: 80};
            const width = container.offsetWidth - margin.left - margin.right;
            const height = 380 - margin.top - margin.bottom;

            const svg = d3.select('#chart4')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const data = extractOFTOProjectData();

            // Get unique tender rounds
            const tenderRounds = [...new Set(data.map(d => d.tr))].sort();

            // Color scale for tender rounds
            const colorScale = d3.scaleOrdinal()
                .domain(tenderRounds)
                .range([colors.orange, '#ef4444', colors.blue, colors.lightBlue, colors.teal, colors.green, colors.purple, '#8b5cf6']);

            // Scales
            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.capacity) * 1.05])
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.value) * 1.05])
                .range([height, 0]);

            const z = d3.scaleSqrt()
                .domain([0, d3.max(data, d => d.trs)])
                .range([4, 30]);

            // Grid lines
            svg.append('g')
                .attr('class', 'grid')
                .attr('opacity', 0.1)
                .call(d3.axisLeft(y).tickSize(-width).tickFormat(''));

            // Create tooltip
            const tooltip = d3.select('body').append('div')
                .style('position', 'absolute')
                .style('visibility', 'hidden')
                .style('background-color', 'white')
                .style('border', '1px solid #ddd')
                .style('border-radius', '6px')
                .style('padding', '12px')
                .style('box-shadow', '0 4px 6px rgba(0,0,0,0.1)')
                .style('font-size', '13px')
                .style('pointer-events', 'none')
                .style('z-index', '1000');

            // Bubbles
            svg.selectAll('.bubble')
                .data(data)
                .enter()
                .append('circle')
                .attr('class', 'bubble')
                .attr('cx', d => x(d.capacity))
                .attr('cy', d => y(d.value))
                .attr('r', d => z(d.trs))
                .attr('fill', d => colorScale(d.tr))
                .attr('opacity', 0.6)
                .attr('stroke', d => d3.rgb(colorScale(d.tr)).darker(1))
                .attr('stroke-width', 1.5)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('opacity', 0.9)
                        .attr('stroke-width', 3);

                    tooltip.html(`
                        <strong style="color: ${colors.blue}; font-size: 14px;">${d.project} (${d.year})</strong><br/>
                        <strong>Tender Round:</strong> ${d.tr}<br/>
                        <strong>Capacity:</strong> ${d.capacity.toLocaleString()} MW<br/>
                        <strong>Transfer Value:</strong> £${d.value.toLocaleString()}m<br/>
                        <strong>Annual TRS:</strong> £${d.trs.toFixed(2)}m<br/>
                        <strong>TRS per MW:</strong> £${d.trs_per_mw.toLocaleString()}
                    `)
                    .style('visibility', 'visible');
                })
                .on('mousemove', function(event) {
                    tooltip
                        .style('top', (event.pageY - 10) + 'px')
                        .style('left', (event.pageX + 10) + 'px');
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('opacity', 0.6)
                        .attr('stroke-width', 1.5);

                    tooltip.style('visibility', 'hidden');
                });

            // X-axis
            svg.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(6).tickFormat(d => `${d} MW`))
                .selectAll('text')
                .style('font-size', '10px');

            // Y-axis
            svg.append('g')
                .attr('class', 'axis')
                .call(d3.axisLeft(y).ticks(6).tickFormat(d => `£${d}m`));

            // Axis labels
            svg.append('text')
                .attr('x', width / 2)
                .attr('y', height + 45)
                .attr('text-anchor', 'middle')
                .attr('font-size', '12px')
                .attr('font-weight', '600')
                .attr('fill', colors.gray)
                .text('Capacity (MW)');

            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', -60)
                .attr('text-anchor', 'middle')
                .attr('font-size', '12px')
                .attr('font-weight', '600')
                .attr('fill', colors.gray)
                .text('Transfer Value (£m)');

            // Remove axis lines for cleaner look
            svg.selectAll('.axis path').remove();
            svg.selectAll('.axis line').attr('stroke', colors.lightGray);
        }

        // Initialize charts with sample data on page load
        window.addEventListener('load', () => {
            processDataForVisualizations();
            renderAllCharts();
        });

        // Re-render charts on window resize for responsiveness
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (activeTab === 'visualizations') {
                    renderAllCharts();
                }
            }, 250);
        });

        // ===== TENDER PROCESS MODAL FUNCTIONS =====
        function openTenderProcess() {
            const modal = document.getElementById('tenderProcessModal');
            const content = document.getElementById('tenderProcessContent');

            // Load the tender process content
            content.innerHTML = getTenderProcessHTML();

            // Show modal
            modal.classList.remove('hidden');

            // Scroll modal to top
            modal.scrollTop = 0;

            // Also scroll window to top to ensure modal is visible from the start
            window.scrollTo(0, 0);
        }

        function closeTenderProcess() {
            const modal = document.getElementById('tenderProcessModal');
            modal.classList.add('hidden');
        }

        // Close modal when clicking outside
        document.getElementById('tenderProcessModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeTenderProcess();
            }
        });

        function getTenderProcessHTML() {
            return `
                <div class="text-center mb-8">
                    <p class="text-xl text-gray-600 font-medium">From Project Qualification to Offshore Transmission Owner (OFTO)</p>
                    <p class="text-sm text-gray-500 mt-2">(Non-Technical Summary)</p>
                </div>

                <div class="space-y-8">
                    <!-- Stage 1 -->
                    <div class="relative">
                        <div class="bg-white rounded-lg p-6 shadow-md hover:shadow-lg transition-shadow">
                            <div class="flex items-start">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-xl mr-4 flex-shrink-0" style="background-color: #FEEBC8; color: #78350F;">1</div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900 mb-1">Qualifying projects and tender start</h2>
                                    <p class="inline-block text-sm font-semibold py-1 px-3 rounded-full mb-3" style="background-color: #FEEBC8; color: #78350F;">PRE-TENDER SETUP (Developer-Led)</p>
                                    <p class="text-gray-700 mb-2">The Developer officially requests to start the tender. OFGEM initiates and reviews the project's requirements (e.g., permits, contracts) and sets an initial cost estimate (Initial Transfer Value).</p>
                                    <div class="mt-4 border-t pt-3">
                                        <p class="text-sm font-semibold text-gray-700">Key outcome:</p>
                                        <p class="text-sm text-gray-600">Project is confirmed as a 'Qualifying Project', and the Tender formally begins.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stage 2 -->
                    <div class="relative">
                        <div class="bg-white rounded-lg p-6 shadow-md hover:shadow-lg transition-shadow">
                            <div class="flex items-start">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-xl mr-4 flex-shrink-0" style="background-color: #FEEBC8; color: #78350F;">2</div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900 mb-1">Pre-qualification (PQ / EPQ)</h2>
                                    <p class="inline-block text-sm font-semibold py-1 px-3 rounded-full mb-3" style="background-color: #FEEBC8; color: #78350F;">BIDDER SELECTION (6 Months)</p>
                                    <p class="text-gray-700 mb-2">Bidders express interest, sign confidentiality agreements, and submit high-level documents demonstrating their financial strength, legal standing, and technical capability.</p>
                                    <div class="mt-4 border-t pt-3">
                                        <p class="text-sm font-semibold text-gray-700">Key outcome:</p>
                                        <p class="text-sm text-gray-600">Creation of a 'Qualifying Bidder' shortlist invited to the main tender stage. Confidential project information is released to them via a Data Room.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stage 3 -->
                    <div class="relative">
                        <div class="bg-white rounded-lg p-6 shadow-md hover:shadow-lg transition-shadow">
                            <div class="flex items-start">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-xl mr-4 flex-shrink-0" style="background-color: #D1E9FF; color: #1E40AF;">3</div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900 mb-1">Invitation to tender (ITT)</h2>
                                    <p class="inline-block text-sm font-semibold py-1 px-3 rounded-full mb-3" style="background-color: #D1E9FF; color: #1E40AF;">MAIN COMMERCIAL BID (6 Months)</p>
                                    <p class="text-gray-700 mb-2">Qualifying Bidders submit their detailed commercial proposals, including their proposed Tender Revenue Stream (TRS), which is the total expected revenue over the licence term. OFGEM provides an updated cost estimate (Indicative Transfer Value).</p>
                                    <div class="mt-4 border-t pt-3">
                                        <p class="text-sm font-semibold text-gray-700">Key outcome:</p>
                                        <p class="text-sm text-gray-600">The Bidder with the most economic and efficient bid is chosen as the 'Preferred Bidder' (PB).</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stage 4 -->
                    <div class="relative">
                        <div class="bg-white rounded-lg p-6 shadow-md hover:shadow-lg transition-shadow">
                            <div class="flex items-start">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-xl mr-4 flex-shrink-0" style="background-color: #D1E9FF; color: #1E40AF;">4</div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900 mb-1">Best and final offer (BAFO)</h2>
                                    <p class="inline-block text-sm font-semibold py-1 px-3 rounded-full mb-3" style="background-color: #D1E9FF; color: #1E40AF;">OPTIONAL: FINAL COMPETITION</p>
                                    <p class="text-gray-700 mb-2">If the ITT results are too close, OFGEM may run this stage to sharpen the competition and obtain the best possible value for consumers.</p>
                                    <div class="mt-4 border-t pt-3">
                                        <p class="text-sm font-semibold text-gray-700">Key outcome:</p>
                                        <p class="text-sm text-gray-600">A clear 'Preferred Bidder' is definitively selected based on the final offer.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stage 5 -->
                    <div class="relative">
                        <div class="bg-white rounded-lg p-6 shadow-md hover:shadow-lg transition-shadow">
                            <div class="flex items-start">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-xl mr-4 flex-shrink-0" style="background-color: #D1FAE5; color: #065F46;">5</div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900 mb-1">Preferred bidder (PB) stage</h2>
                                    <p class="inline-block text-sm font-semibold py-1 px-3 rounded-full mb-3" style="background-color: #D1FAE5; color: #065F46;">CONFIRMATORY DUE DILIGENCE (6 Months)</p>
                                    <p class="text-gray-700 mb-2">The PB works directly with the Developer to finalize all commercial, legal, and financing agreements (the PB Matters). OFGEM simultaneously calculates the Final Transfer Value (FTV) based on an audit of the Developer's actual construction costs.</p>
                                    <div class="mt-4 p-3 bg-red-50 border-l-4 border-red-500 rounded-lg">
                                        <p class="text-sm font-bold text-red-700">CRITICAL REGULATORY DEADLINE</p>
                                        <p class="text-xs text-red-600 mt-1">The Developer must transfer the assets within 18 months (subject to change with new round) from the date the assets become available for use (commissioning). The PB stage must be completed efficiently to meet this Generator Commissioning Clause deadline.</p>
                                    </div>
                                    <div class="mt-4 border-t pt-3">
                                        <p class="text-sm font-semibold text-gray-700">Key outcome:</p>
                                        <p class="text-sm text-gray-600">All PB Matters are resolved, and OFGEM completes the cost assessment to set the non-negotiable FTV.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stage 6 -->
                    <div class="relative">
                        <div class="bg-white rounded-lg p-6 shadow-md hover:shadow-lg transition-shadow">
                            <div class="flex items-start">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-xl mr-4 flex-shrink-0" style="background-color: #D1FAE5; color: #065F46;">6</div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900 mb-1">Successful bidder (SB) and licence grant</h2>
                                    <p class="inline-block text-sm font-semibold py-1 px-3 rounded-full mb-3" style="background-color: #D1FAE5; color: #065F46;">FINAL ASSET TRANSFER</p>
                                    <p class="text-gray-700 mb-2">The PB becomes the 'Successful Bidder'. Following a 10-day legal standstill period, the OFTO Licence is granted, financial close is achieved, and the Transmission Assets transfer from the Developer to the new OFTO.</p>
                                    <div class="mt-4 border-t pt-3">
                                        <p class="text-sm font-semibold text-gray-700">Key outcome:</p>
                                        <p class="text-sm text-gray-600">The Successful Bidder is the new Offshore Transmission Owner (OFTO), receiving the assets and the regulated revenue stream (TRS) adjusted for the FTV. Asset transfer must occur before the 18-month statutory deadline.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Box -->
                    <div class="mt-8 p-8 bg-blue-50 border-l-4 border-blue-500 rounded-lg shadow-lg">
                        <h3 class="text-2xl font-bold text-blue-800 mb-4">Why is this process structured this way?</h3>
                        <ul class="space-y-3 text-gray-700">
                            <li class="flex items-start">
                                <span class="text-blue-500 font-bold mr-3 text-lg">&bull;</span>
                                <div><span class="font-semibold">Best value for consumers:</span> The competitive nature (ITT/BAFO) drives down the long-term revenue stream (TRS) to the lowest possible cost, directly benefiting energy consumers.</div>
                            </li>
                            <li class="flex items-start">
                                <span class="text-blue-500 font-bold mr-3 text-lg">&bull;</span>
                                <div><span class="font-semibold">Financial and technical rigour:</span> The PQ/EPQ stage ensures that only robust, capable entities are allowed to operate critical national infrastructure.</div>
                            </li>
                            <li class="flex items-start">
                                <span class="text-blue-500 font-bold mr-3 text-lg">&bull;</span>
                                <div><span class="font-semibold">Cost control:</span> OFGEM's independent Cost Assessment determines the Final Transfer Value (FTV), preventing the Developer from selling the assets for more than their economic and efficient cost.</div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="mt-8 text-center">
                    <button onclick="closeTenderProcess()" class="px-8 py-3 rounded font-bold text-white hover:opacity-90 transition-opacity" style="background: linear-gradient(135deg, var(--mckinsey-blue) 0%, var(--mckinsey-light-blue) 100%);">
                        Return to Report
                    </button>
                </div>
            `;
        }

        // ===== OVERVIEW MODAL FUNCTIONS =====
        function openOverview() {
            const modal = document.getElementById('overviewModal');
            const content = document.getElementById('overviewContent');

            // Load the overview content
            content.innerHTML = getOverviewHTML();

            // Show modal
            modal.classList.remove('hidden');

            // Scroll modal to top
            modal.scrollTop = 0;

            // Also scroll window to top to ensure modal is visible from the start
            window.scrollTo(0, 0);
        }

        function closeOverview() {
            const modal = document.getElementById('overviewModal');
            modal.classList.add('hidden');
        }

        // Close modal when clicking outside
        document.getElementById('overviewModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeOverview();
            }
        });

        function getOverviewHTML() {
            return `
                <div class="text-center mb-10">
                    <h2 class="text-4xl font-bold text-gray-800 mb-2">Powering the Future</h2>
                    <h3 class="text-xl font-semibold mb-4" style="color: var(--mckinsey-teal);">An Overview of the UK's Offshore Transmission Owner (OFTO) Regime</h3>
                    <p class="max-w-3xl mx-auto text-gray-600">The OFTO regime is the foundational regulatory model attracting private capital to connect the UK's world-leading offshore wind farms to the national grid, balancing competition with strategic national energy goals.</p>
                </div>

                <!-- KPI Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                    <div class="bg-white p-6 rounded-lg shadow-lg border-t-4" style="border-color: var(--mckinsey-blue);">
                        <p class="text-sm font-semibold mb-2" style="color: var(--mckinsey-teal);">Private Investment Mobilised</p>
                        <p class="text-5xl font-black mb-2" style="color: var(--chart-orange);">£9.5B+</p>
                        <p class="text-sm text-gray-600">in transmission assets (up to TR8), de-risking the UK's energy transition.</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg border-t-4" style="border-color: var(--mckinsey-blue);">
                        <p class="text-sm font-semibold mb-2" style="color: var(--mckinsey-teal);">Offshore Capacity Connected</p>
                        <p class="text-5xl font-black mb-2" style="color: var(--chart-orange);">12GW+</p>
                        <p class="text-sm text-gray-600">in transmission capacity (up to TR8).</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg border-t-4" style="border-color: var(--mckinsey-blue);">
                        <p class="text-sm font-semibold mb-2" style="color: var(--mckinsey-teal);">Total Annual Unindexed TRS Value</p>
                        <p class="text-5xl font-black mb-2" style="color: var(--chart-orange);">£550M+</p>
                        <p class="text-sm text-gray-600">annual payment the OFTOs receive from the system operator.</p>
                    </div>
                </div>

                <!-- Strategic Mandate -->
                <div class="bg-white p-8 rounded-lg shadow-lg mb-12">
                    <h3 class="text-2xl font-bold text-center mb-8" style="color: var(--mckinsey-blue);">The Strategic Mandate</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="text-center p-6 rounded-lg" style="background-color: #f0f4f8;">
                            <div class="text-4xl mb-3">⚡</div>
                            <h4 class="text-lg font-bold mb-2" style="color: var(--mckinsey-blue);">Secure Energy Supply</h4>
                            <p class="text-sm text-gray-600">Ensuring reliable connections for future electricity needs.</p>
                        </div>
                        <div class="text-center p-6 rounded-lg" style="background-color: #f0f4f8;">
                            <div class="text-4xl mb-3">🍃</div>
                            <h4 class="text-lg font-bold mb-2" style="color: var(--mckinsey-blue);">Drive Decarbonisation</h4>
                            <p class="text-sm text-gray-600">Accelerating the transition away from fossil fuels.</p>
                        </div>
                        <div class="text-center p-6 rounded-lg" style="background-color: #f0f4f8;">
                            <div class="text-4xl mb-3">💰</div>
                            <h4 class="text-lg font-bold mb-2" style="color: var(--mckinsey-blue);">Minimise Consumer Cost</h4>
                            <p class="text-sm text-gray-600">Using competition to deliver long-term value for money.</p>
                        </div>
                        <div class="text-center p-6 rounded-lg" style="background-color: #f0f4f8;">
                            <div class="text-4xl mb-3">🔧</div>
                            <h4 class="text-lg font-bold mb-2" style="color: var(--mckinsey-blue);">Fit-for-Purpose Systems</h4>
                            <p class="text-sm text-gray-600">Delivering resilient and high-quality transmission infrastructure.</p>
                        </div>
                    </div>
                </div>

                <!-- How It Works -->
                <div class="bg-white p-8 rounded-lg shadow-lg mb-12">
                    <h3 class="text-2xl font-bold text-center mb-2" style="color: var(--mckinsey-blue);">How It Works: The "Generator Build" Model</h3>
                    <p class="text-center max-w-2xl mx-auto text-gray-600 mb-8">The OFTO regime operates through a structured, multi-stage process that transfers transmission assets from wind farm developers to specialized, long-term owners.</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                        <div class="text-center p-6 rounded-lg" style="background-color: #f0f4f8; border-left: 4px solid var(--chart-orange);">
                            <div class="text-xl font-bold mb-2" style="color: var(--chart-orange);">Step 1</div>
                            <h4 class="text-lg font-semibold mb-2" style="color: var(--mckinsey-blue);">Construction</h4>
                            <p class="text-sm text-gray-600">Offshore wind farm developer builds the generation and transmission assets together.</p>
                        </div>

                        <div class="text-center hidden md:block">
                            <div class="text-4xl font-bold" style="color: var(--mckinsey-teal);">→</div>
                        </div>

                        <div class="text-center p-6 rounded-lg" style="background-color: #f0f4f8; border-left: 4px solid var(--chart-orange);">
                            <div class="text-xl font-bold mb-2" style="color: var(--chart-orange);">Step 2</div>
                            <h4 class="text-lg font-semibold mb-2" style="color: var(--mckinsey-blue);">Tender Process</h4>
                            <p class="text-sm text-gray-600">Ofgem runs a competitive tender to select a bidder to become the OFTO for the new assets.</p>
                        </div>
                    </div>

                    <div class="text-center my-6 md:hidden">
                        <div class="text-4xl font-bold" style="color: var(--mckinsey-teal);">↓</div>
                    </div>

                    <div class="text-center mt-6 md:hidden">
                        <div class="text-4xl font-bold" style="color: var(--mckinsey-teal);">↓</div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                        <div class="md:col-start-2 text-center p-6 rounded-lg" style="background-color: #f0f4f8; border-left: 4px solid var(--chart-orange);">
                            <div class="text-xl font-bold mb-2" style="color: var(--chart-orange);">Step 3</div>
                            <h4 class="text-lg font-semibold mb-2" style="color: var(--mckinsey-blue);">Asset Transfer</h4>
                            <p class="text-sm text-gray-600">Winning bidder acquires the transmission assets post-construction and is granted a 25-year OFTO licence.</p>
                        </div>
                    </div>
                </div>

                <!-- Market Architecture -->
                <div class="bg-white p-8 rounded-lg shadow-lg mb-12">
                    <h3 class="text-2xl font-bold mb-4" style="color: var(--mckinsey-blue);">Market Architecture: The Principle of Unbundling</h3>
                    <p class="text-gray-600 mb-4">A core philosophy of the OFTO regime is the legal and operational separation ("unbundling") of electricity generation from transmission. This prevents monopolies and fosters a competitive environment for transmission ownership and maintenance, which is overseen by the regulator, Ofgem.</p>
                    <p class="text-gray-700 font-semibold mb-6" style="color: var(--mckinsey-gray);">This structure creates a unique hybrid market: a highly regulated framework that uses competition to drive efficiency and innovation.</p>

                    <div class="p-6 rounded-lg relative" style="background-color: #f0f4f8;">
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="p-4 rounded-lg text-center" style="background-color: var(--mckinsey-teal); color: white;">
                                <h5 class="font-bold mb-1">Wind Farm Generator</h5>
                                <p class="text-sm">Develops & Operates Wind Turbines</p>
                            </div>
                            <div class="p-4 rounded-lg text-center" style="background-color: var(--chart-orange); color: white;">
                                <h5 class="font-bold mb-1">OFTO</h5>
                                <p class="text-sm">Owns & Maintains Transmission Assets</p>
                            </div>
                        </div>

                        <div class="relative my-6">
                            <div class="border-t-4 border-dashed" style="border-color: var(--chart-orange);"></div>
                            <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 px-4 py-1 rounded" style="background-color: #f0f4f8;">
                                <p class="font-bold text-lg" style="color: var(--chart-orange);">Unbundled</p>
                            </div>
                        </div>

                        <div class="text-center p-4 rounded-lg" style="background-color: var(--mckinsey-gray); color: white;">
                            <h5 class="font-bold mb-1">Ofgem (Regulator)</h5>
                            <p class="text-sm">Awards Licences & Oversees Regime</p>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-center">
                    <button onclick="closeOverview()" class="px-8 py-3 rounded font-bold text-white hover:opacity-90 transition-opacity" style="background: linear-gradient(135deg, var(--mckinsey-blue) 0%, var(--mckinsey-light-blue) 100%);">
                        Return to Report
                    </button>
                </div>
            `;
        }

        // ===== REGULATORY MILESTONES MODAL FUNCTIONS =====
        function openRegulatoryMilestones() {
            const modal = document.getElementById('regulatoryMilestonesModal');
            const content = document.getElementById('regulatoryMilestonesContent');

            // Load the regulatory milestones content
            content.innerHTML = getRegulatoryMilestonesHTML();

            // Show modal
            modal.classList.remove('hidden');

            // Scroll modal to top
            modal.scrollTop = 0;

            // Also scroll window to top to ensure modal is visible from the start
            window.scrollTo(0, 0);
        }

        function closeRegulatoryMilestones() {
            const modal = document.getElementById('regulatoryMilestonesModal');
            modal.classList.add('hidden');
        }

        // Close modal when clicking outside
        document.getElementById('regulatoryMilestonesModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeRegulatoryMilestones();
            }
        });

        function getRegulatoryMilestonesHTML() {
            return `
                <div class="text-center mb-8">
                    <h2 class="text-4xl font-bold text-gray-800 mb-2">OFTO Policy: Two Decades of Competitive Transmission</h2>
                    <p class="text-lg font-medium" style="color: var(--mckinsey-light-blue);">Key Regulatory Milestones for the UK Offshore Wind Grid (2004–2025)</p>
                </div>

                <!-- Phase 1: Foundation and Initial Launch (2004-2013) -->
                <div class="mb-12">
                    <h3 class="text-2xl font-bold mb-4 pb-2" style="color: #ef4444; border-bottom: 3px solid #ef4444;">Phase 1: Foundation and Initial Launch (2004–2013)</h3>

                    <div class="overflow-x-auto pb-4 shadow-inner bg-gray-50 p-4 rounded-xl">
                        <div class="flex gap-6" style="min-width: min-content;">
                            <!-- Milestone 1 -->
                            <div class="flex-shrink-0 bg-white rounded-xl shadow-lg p-5 border-t-8 border-red-500 transition-all duration-300 hover:scale-105 hover:shadow-xl" style="width: 280px; min-height: 200px;">
                                <span class="text-sm font-bold tracking-wider uppercase px-3 py-1 rounded-full bg-red-100 text-red-800 inline-block mb-2">2004</span>
                                <h4 class="text-lg font-extrabold text-gray-900 mb-2">Enabling Legislation</h4>
                                <p class="text-sm text-gray-600 leading-snug">Energy Act 2004 granted powers to introduce a competitive offshore transmission regime (Sections 92, inserting Electricity Act 1989 s.6C).</p>
                            </div>

                            <!-- Milestone 2 -->
                            <div class="flex-shrink-0 bg-white rounded-xl shadow-lg p-5 border-t-8 border-red-500 transition-all duration-300 hover:scale-105 hover:shadow-xl" style="width: 280px; min-height: 200px;">
                                <span class="text-sm font-bold tracking-wider uppercase px-3 py-1 rounded-full bg-red-100 text-red-800 inline-block mb-2">Mar 2006</span>
                                <h4 class="text-lg font-extrabold text-gray-900 mb-2">Regulated Asset Decision</h4>
                                <p class="text-sm text-gray-600 leading-snug">UK confirmed offshore transmission would be a licensed, regulated asset model, initiating policy development.</p>
                            </div>

                            <!-- Milestone 3 -->
                            <div class="flex-shrink-0 bg-white rounded-xl shadow-lg p-5 border-t-8 border-red-500 transition-all duration-300 hover:scale-105 hover:shadow-xl" style="width: 280px; min-height: 200px;">
                                <span class="text-sm font-bold tracking-wider uppercase px-3 py-1 rounded-full bg-red-100 text-red-800 inline-block mb-2">Jun 2009</span>
                                <h4 class="text-lg font-extrabold text-gray-900 mb-2">Regime Go-Active</h4>
                                <p class="text-sm text-gray-600 leading-snug">Competitive Tender Regulations 2009 came into force, launching the competitive model to achieve lower costs.</p>
                            </div>

                            <!-- Milestone 4 -->
                            <div class="flex-shrink-0 bg-white rounded-xl shadow-lg p-5 border-t-8 border-red-500 transition-all duration-300 hover:scale-105 hover:shadow-xl" style="width: 280px; min-height: 200px;">
                                <span class="text-sm font-bold tracking-wider uppercase px-3 py-1 rounded-full bg-red-100 text-red-800 inline-block mb-2">Jul 2009</span>
                                <h4 class="text-lg font-extrabold text-gray-900 mb-2">Tender Round 1 Opens</h4>
                                <p class="text-sm text-gray-600 leading-snug">First Transitional Tender Round (TR1) opened for nine early projects, showing strong market interest despite the credit crunch.</p>
                            </div>

                            <!-- Milestone 5 -->
                            <div class="flex-shrink-0 bg-white rounded-xl shadow-lg p-5 border-t-8 border-red-500 transition-all duration-300 hover:scale-105 hover:shadow-xl" style="width: 280px; min-height: 200px;">
                                <span class="text-sm font-bold tracking-wider uppercase px-3 py-1 rounded-full bg-red-100 text-red-800 inline-block mb-2">2011–2014</span>
                                <h4 class="text-lg font-extrabold text-gray-900 mb-2">First OFTO Licenses</h4>
                                <p class="text-sm text-gray-600 leading-snug">TR1 assets (£1.1bn value) successfully transferred, validating the model and attracting competitive financing.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phase 2: Full Implementation and Review (2012-2016) -->
                <div class="mb-12">
                    <h3 class="text-2xl font-bold mb-4 pb-2" style="color: #f97316; border-bottom: 3px solid #f97316;">Phase 2: Full Implementation and Review (2012–2016)</h3>

                    <div class="overflow-x-auto pb-4 shadow-inner bg-gray-50 p-4 rounded-xl">
                        <div class="flex gap-6" style="min-width: min-content;">
                            <!-- Milestone 6 -->
                            <div class="flex-shrink-0 bg-white rounded-xl shadow-lg p-5 border-t-8 border-orange-500 transition-all duration-300 hover:scale-105 hover:shadow-xl" style="width: 280px; min-height: 200px;">
                                <span class="text-sm font-bold tracking-wider uppercase px-3 py-1 rounded-full bg-orange-100 text-orange-800 inline-block mb-2">Jun 2012</span>
                                <h4 class="text-lg font-extrabold text-gray-900 mb-2">NAO Report</h4>
                                <p class="text-sm text-gray-600 leading-snug">National Audit Office evaluated the model, citing innovation but raising caution regarding high transaction costs and consumer risks.</p>
                            </div>

                            <!-- Milestone 7 -->
                            <div class="flex-shrink-0 bg-white rounded-xl shadow-lg p-5 border-t-8 border-orange-500 transition-all duration-300 hover:scale-105 hover:shadow-xl" style="width: 280px; min-height: 200px;">
                                <span class="text-sm font-bold tracking-wider uppercase px-3 py-1 rounded-full bg-orange-100 text-orange-800 inline-block mb-2">Early 2013</span>
                                <h4 class="text-lg font-extrabold text-gray-900 mb-2">Enduring Regime</h4>
                                <p class="text-sm text-gray-600 leading-snug">New projects moved to the Enduring regime, which included the option for an "OFTO build" (though "generator build" remained the standard).</p>
                            </div>

                            <!-- Milestone 8 -->
                            <div class="flex-shrink-0 bg-white rounded-xl shadow-lg p-5 border-t-8 border-orange-500 transition-all duration-300 hover:scale-105 hover:shadow-xl" style="width: 280px; min-height: 200px;">
                                <span class="text-sm font-bold tracking-wider uppercase px-3 py-1 rounded-full bg-orange-100 text-orange-800 inline-block mb-2">Jun 2014</span>
                                <h4 class="text-lg font-extrabold text-gray-900 mb-2">Full Commencement</h4>
                                <p class="text-sm text-gray-600 leading-snug">Generator Commissioning Clause mandated an 18-month test window before mandatory asset transfer, de-risking projects for buyers.</p>
                            </div>

                            <!-- Milestone 9 -->
                            <div class="flex-shrink-0 bg-white rounded-xl shadow-lg p-5 border-t-8 border-orange-500 transition-all duration-300 hover:scale-105 hover:shadow-xl" style="width: 280px; min-height: 200px;">
                                <span class="text-sm font-bold tracking-wider uppercase px-3 py-1 rounded-full bg-orange-100 text-orange-800 inline-block mb-2">Sept 2014</span>
                                <h4 class="text-lg font-extrabold text-gray-900 mb-2">TR1 Benefits Confirmed</h4>
                                <p class="text-sm text-gray-600 leading-snug">Ofgem review confirmed £200–£400 million in consumer savings achieved in the first tender round (TR1).</p>
                            </div>

                            <!-- Milestone 10 -->
                            <div class="flex-shrink-0 bg-white rounded-xl shadow-lg p-5 border-t-8 border-orange-500 transition-all duration-300 hover:scale-105 hover:shadow-xl" style="width: 280px; min-height: 200px;">
                                <span class="text-sm font-bold tracking-wider uppercase px-3 py-1 rounded-full bg-orange-100 text-orange-800 inline-block mb-2">2018</span>
                                <h4 class="text-lg font-extrabold text-gray-900 mb-2">25-Year Licenses</h4>
                                <p class="text-sm text-gray-600 leading-snug">Policy refined to extend OFTO licenses from 20 to 25 years (from TR5) to align with longer asset life and reduce annual charges.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phase 3: Scaling and Future Coordination (2018-2025) -->
                <div class="mb-8">
                    <h3 class="text-2xl font-bold mb-4 pb-2" style="color: #3b82f6; border-bottom: 3px solid #3b82f6;">Phase 3: Scaling and Future Coordination (2018–2025)</h3>

                    <div class="overflow-x-auto pb-4 shadow-inner bg-gray-50 p-4 rounded-xl">
                        <div class="flex gap-6" style="min-width: min-content;">
                            <!-- Milestone 11 -->
                            <div class="flex-shrink-0 bg-white rounded-xl shadow-lg p-5 border-t-8 border-blue-500 transition-all duration-300 hover:scale-105 hover:shadow-xl" style="width: 280px; min-height: 200px;">
                                <span class="text-sm font-bold tracking-wider uppercase px-3 py-1 rounded-full bg-blue-100 text-blue-800 inline-block mb-2">2018–2020</span>
                                <h4 class="text-lg font-extrabold text-gray-900 mb-2">Growing Scale</h4>
                                <p class="text-sm text-gray-600 leading-snug">Projects scaled up significantly (e.g., Hornsea One link ~£1.17bn). Total investment passed ~£5.7b across 21 licenses.</p>
                            </div>

                            <!-- Milestone 12 -->
                            <div class="flex-shrink-0 bg-white rounded-xl shadow-lg p-5 border-t-8 border-blue-500 transition-all duration-300 hover:scale-105 hover:shadow-xl" style="width: 280px; min-height: 200px;">
                                <span class="text-sm font-bold tracking-wider uppercase px-3 py-1 rounded-full bg-blue-100 text-blue-800 inline-block mb-2">Jul 2020</span>
                                <h4 class="text-lg font-extrabold text-gray-900 mb-2">OTNR Launched</h4>
                                <p class="text-sm text-gray-600 leading-snug">Offshore Transmission Network Review (OTNR) initiated to address challenges of the radial approach due to planned 40+ GW expansion.</p>
                            </div>

                            <!-- Milestone 13 -->
                            <div class="flex-shrink-0 bg-white rounded-xl shadow-lg p-5 border-t-8 border-blue-500 transition-all duration-300 hover:scale-105 hover:shadow-xl" style="width: 280px; min-height: 200px;">
                                <span class="text-sm font-bold tracking-wider uppercase px-3 py-1 rounded-full bg-blue-100 text-blue-800 inline-block mb-2">May 2023</span>
                                <h4 class="text-lg font-extrabold text-gray-900 mb-2">OTNR Conclusions</h4>
                                <p class="text-sm text-gray-600 leading-snug">Government outlined reforms, including plans for multi-purpose interconnectors and shared infrastructure to optimize future grid development.</p>
                            </div>

                            <!-- Milestone 14 -->
                            <div class="flex-shrink-0 bg-white rounded-xl shadow-lg p-5 border-t-8 border-indigo-600 transition-all duration-300 hover:scale-105 hover:shadow-xl" style="width: 280px; min-height: 200px;">
                                <span class="text-sm font-bold tracking-wider uppercase px-3 py-1 rounded-full bg-indigo-100 text-indigo-800 inline-block mb-2">Mid 2025</span>
                                <h4 class="text-lg font-extrabold text-gray-900 mb-2">OFGEM Response to Industry</h4>
                                <p class="text-sm text-gray-600 leading-snug">OFGEM decided to extend the Generator Commissioning Clause window by 9 months (from 18 to 27 months) to relieve timing pressure. Also published decisions allowing economically viable OFTO assets to operate beyond their initial 20-25 years.</p>
                            </div>

                            <!-- Milestone 15 -->
                            <div class="flex-shrink-0 bg-white rounded-xl shadow-lg p-5 border-t-8 border-indigo-600 transition-all duration-300 hover:scale-105 hover:shadow-xl" style="width: 280px; min-height: 200px;">
                                <span class="text-sm font-bold tracking-wider uppercase px-3 py-1 rounded-full bg-indigo-100 text-indigo-800 inline-block mb-2">Sep 2025</span>
                                <h4 class="text-lg font-extrabold text-gray-900 mb-2">Exploring Early OFTO Build Model</h4>
                                <p class="text-sm text-gray-600 leading-snug">Expected to issue final decisions by end of 2025, shaping new license conditions and tender rules.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-center">
                    <button onclick="closeRegulatoryMilestones()" class="px-8 py-3 rounded font-bold text-white hover:opacity-90 transition-opacity" style="background: linear-gradient(135deg, var(--mckinsey-blue) 0%, var(--mckinsey-light-blue) 100%);">
                        Return to Report
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>
